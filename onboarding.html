<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SignalBench beta | Onboarding</title>
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon/favicon-16x16.png" />
  <link rel="apple-touch-icon" href="icons/favicon/apple-touch-icon.png" />
  <link rel="manifest" href="icons/favicon/site.webmanifest" />
  <link rel="stylesheet" href="ui_shell.css" />
  <script src="ui_theme.js"></script>
  <script src="ui_store.js"></script>
  <script src="ui_guard.js?v=2026-02-28"></script>
</head>
<body data-page="onboarding">
  <!--
    Integration Notes (Onboarding)
    - Create U01 from name/email/resume + consent
    - Save preferences: career level (up to 2), employment status, tone, length
    - Route to /casefile/new
  -->
  <div class="wrap">
    <div class="page">
                  <header class="page-header">
        <div class="brand large">
          <div class="brand-logo" aria-hidden="true">
            <img src="icons/logo1_round_80.png" alt="SignalBench logo" />
          </div>
          <span class="brand-name">SignalBench</span>
        </div>
      </header>

      <main class="page-body">
        <section class="card">
          <h1 class="title">Create Your Candidate Profile</h1>
          <p class="subtitle">
            SignalBench builds a candidate profile anchored in your resume, then strengthens it over time as the
            system learns who you are, what you've done, and where you're headed next in your career.
            <br /><br />
            To begin, upload your base resume by attaching the file or pasting the text below. You'll also be asked
            a few brief questions to give the system helpful context about your goals and direction.
          </p>
        </section>

        <section class="card">
          <h2 class="title" style="font-size:22px;">Privacy &amp; Terms</h2>
          <p class="subtitle">
            Interview.OS does not require sensitive personal information. Please avoid uploading Social Security numbers or unrelated private data.
          </p>
          <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
            <input type="checkbox" id="consentBox" />
            <span>I agree to the <a href="terms.html" target="_blank" rel="noopener">Terms &amp; Conditions</a></span>
          </label>
          <label style="display:flex; gap:8px; align-items:center; margin-top:8px;">
            <input type="checkbox" id="privacyBox" />
            <span>I acknowledge the <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a></span>
          </label>
        </section>

        <section class="card">
          <h2 class="title" style="font-size:22px;">Profile Name and Image</h2>
          <div class="row" style="margin-bottom:10px;">
            <label class="field" style="flex:1">
              <span>How should we address you (optional)</span>
              <input id="preferredName" type="text" placeholder="Preferred name or nickname" />
            </label>
          </div>
          <div class="row" style="align-items:center; gap:12px; justify-content:flex-start;">
            <label class="field" style="max-width:360px;">
              <span>Profile image (optional)</span>
              <input id="profileImage" type="file" accept=".png,.jpg,.jpeg,.webp" />
            </label>
            <div class="avatar" id="profilePreview" aria-label="Profile image preview"></div>
          </div>
        </section>

        <section class="card">
          <h2 class="title" style="font-size:22px;">Resume Upload</h2>
          <label class="field">
            <span>Upload resume (PDF/DOCX/TXT)</span>
            <input id="resumeFile" type="file" accept=".pdf,.docx,.txt" />
          </label>
          <div class="note" style="margin:8px 0;">OR</div>
          <label class="field">
            <span>Paste resume text</span>
            <textarea placeholder="Paste resume text here"></textarea>
          </label>

        </section>

        <section class="card">
          <h2 class="title" style="font-size:22px;">Career Context</h2>
          <p class="subtitle">These settings help SignalBench tailor guidance to your level, situation, and preferences. You can change them anytime.</p>

          <div class="field" style="margin-top:10px;">
            <span>Career level sought for next role</span>
            <div class="note">Select up to two.</div>
            <div class="row" style="flex-direction:column; margin-top:6px;">
              <label class="pill"><input type="checkbox" name="level" value="ic" /> Individual contributor</label>
              <label class="pill"><input type="checkbox" name="level" value="mgr" /> Manager (people manager)</label>
              <label class="pill"><input type="checkbox" name="level" value="dir" /> Director (manages managers)</label>
              <label class="pill"><input type="checkbox" name="level" value="vp" /> VP / General Manager</label>
              <label class="pill"><input type="checkbox" name="level" value="cxo" /> C‑suite / President</label>
              <label class="pill"><input type="checkbox" name="level" value="na" /> Not sure</label>
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <span>Current employment status</span>
            <div class="note">Select one.</div>
            <div class="row" style="flex-direction:column; margin-top:6px;">
              <label class="pill"><input type="radio" name="status" value="ft_adv" /> Employed, exploring internal or external opportunities</label>
              <label class="pill"><input type="radio" name="status" value="pt_contract" /> Contract or part‑time, seeking full‑time</label>
              <label class="pill"><input type="radio" name="status" value="transition_ft" /> In transition, seeking full‑time only</label>
              <label class="pill"><input type="radio" name="status" value="transition_any" /> In transition, open to full‑time, part‑time, or contract</label>
              <label class="pill"><input type="radio" name="status" value="na" /> Prefer not to say</label>
            </div>
          </div>

        </section>

        <section class="card">
          <h2 class="title" style="font-size:22px;">Response Preferences</h2>
          <div class="row">
            <label class="field" style="flex:1">
              <span>Tone</span>
              <input type="range" id="toneSlider" min="0" max="10" value="5" style="width:100%;" />
              <div class="note">Softened and eloquent ←→ Blunt and direct</div>
              <div class="note"><small>The system remains direct and truthful either way.</small></div>
            </label>
            <label class="field" style="flex:1">
              <span>Length</span>
              <input type="range" id="lengthSlider" min="0" max="10" value="5" style="width:100%;" />
              <div class="note">Brief ←→ Detailed</div>
              <div class="note"><small>Choose how concise you want responses to be.</small></div>
            </label>
          </div>
        </section>

        <section class="card">
          <div class="row">
            <button class="btn primary press-invert" id="btnCreateProfile" type="button" disabled>
              Create My Profile and Continue
            </button>
          </div>
        </section>

        <div class="footer-link" style="text-align:center; margin:0; font-size:11px; line-height:1.2;">
          © 2026 SignalBench LLC. All rights reserved.
        </div>
      </main>
    </div>
  </div>

  <script>
    const consentBox = document.getElementById("consentBox");
    const privacyBox = document.getElementById("privacyBox");
    const btn = document.getElementById("btnCreateProfile");
    const toneSlider = document.getElementById("toneSlider");
    const lengthSlider = document.getElementById("lengthSlider");
    const levelChecks = Array.from(document.querySelectorAll("input[name='level']"));
    const statusRadios = Array.from(document.querySelectorAll("input[name='status']"));
    const resumeFile = document.getElementById("resumeFile");
    const resumeText = document.querySelector("textarea");
    const preferredName = document.getElementById("preferredName");
    const profileImage = document.getElementById("profileImage");
    const profilePreview = document.getElementById("profilePreview");
    let profileImageData = "";

    const API_BASE = window.SB_API_BASE || "/api";
    const TERMS_VERSION = "2026-02-28";
    const PRIVACY_VERSION = "2026-02-28";
    const postJson = async (path, payload) => {
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload || {})
      });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch (_err){ data = { raw: text }; }
      if (!res.ok){
        const msg = data.detail || data.error || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    };
    const extractText = async (file) => {
      const form = new FormData();
      form.append("file", file);
      const res = await fetch(`${API_BASE}/extract_text`, {
        method: "POST",
        credentials: "include",
        body: form
      });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch (_err){ data = { raw: text }; }
      if (!res.ok){
        const msg = data.detail || data.error || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    };

    if (profilePreview){
      profilePreview.style.width = "56px";
      profilePreview.style.height = "56px";
      profilePreview.style.borderRadius = "50%";
      profilePreview.style.border = "1px solid var(--line)";
      profilePreview.style.background = "var(--panel)";
      profilePreview.style.overflow = "hidden";
      profilePreview.style.display = "grid";
      profilePreview.style.placeItems = "center";
      profilePreview.innerHTML = '<svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 0 0-16 0"></path><circle cx="12" cy="8" r="4"></circle></svg>';
      profilePreview.style.color = "var(--muted)";
    }

    const isHeic = (file) => {
      const name = (file?.name || "").toLowerCase();
      const type = (file?.type || "").toLowerCase();
      return name.endsWith(".heic") || name.endsWith(".heif") || type.includes("heic") || type.includes("heif");
    };

    if (profileImage){
      profileImage.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file || !profilePreview) return;
        if (isHeic(file)){
          alert("HEIC images are not supported yet. Please upload a JPG, PNG, or WebP.");
          profileImage.value = "";
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          profilePreview.innerHTML = "";
          profilePreview.style.backgroundImage = `url(${reader.result})`;
          profilePreview.style.backgroundSize = "cover";
          profilePreview.style.backgroundPosition = "center";
          profileImageData = String(reader.result || "");
        };
        reader.readAsDataURL(file);
      });
    }

    const enforceLevelLimit = () => {
      const checked = levelChecks.filter((c) => c.checked);
      if (checked.length >= 2){
        levelChecks.filter((c) => !c.checked).forEach((c) => c.disabled = true);
      } else {
        levelChecks.forEach((c) => c.disabled = false);
      }
    };

    const isResumeProvided = () => {
      return (resumeFile && resumeFile.files && resumeFile.files.length > 0) || (resumeText && resumeText.value.trim().length > 0);
    };

    const updateState = () => {
      enforceLevelLimit();
      const levelCount = levelChecks.filter((c) => c.checked).length;
      const statusSelected = statusRadios.some((r) => r.checked);
      const ok = consentBox.checked
        && privacyBox.checked
        && isResumeProvided()
        && levelCount > 0
        && statusSelected
        && toneSlider.value !== ""
        && lengthSlider.value !== "";
      btn.disabled = !ok;
    };

    levelChecks.forEach((c) => c.addEventListener("change", updateState));
    statusRadios.forEach((r) => r.addEventListener("change", updateState));
    consentBox.addEventListener("change", updateState);
    privacyBox.addEventListener("change", updateState);
    toneSlider.addEventListener("input", updateState);
    lengthSlider.addEventListener("input", updateState);
    resumeFile.addEventListener("change", async (e) => {
      updateState();
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try{
        btn.disabled = true;
        const data = await extractText(file);
        resumeText.value = data.text || "";
      } catch (err){
        alert(err?.message || "Could not read that file. Please try a PDF, DOCX, or TXT.");
      } finally {
        updateState();
      }
    });
    resumeText.addEventListener("input", updateState);
    preferredName?.addEventListener("input", updateState);

    btn.addEventListener("click", async () => {
      const store = UIStore.load();
      store.auth = { ...(store.auth || {}), isAuthed: true };
      const existingEmail = store.me?.email || "";
      const preferredValue = preferredName?.value.trim() || "";
      store.me = { id: store.me?.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())), email: existingEmail };
      store.me.full_name = preferredValue;
      store.me.preferred_name = preferredValue;
      if (profileImageData){
        store.me.avatar_data_url = profileImageData;
      }
      store.orch = store.orch || { userId: store.me.id, caseMap: {} };
      store.orch.userId = store.me.id;

      const u01Payload = {
        user_id: store.me.id,
        user_email: existingEmail,
        full_name: preferredValue,
        preferred_name: preferredValue,
        resume_text: resumeText.value.trim(),
        avatar_data_url: profileImageData || "",
        consent: consentBox.checked && privacyBox.checked,
        terms_accepted: consentBox.checked,
        privacy_accepted: privacyBox.checked,
        terms_version: TERMS_VERSION,
        privacy_version: PRIVACY_VERSION
      };
      const prefPayload = {
        user_id: store.me.id,
        user_email: existingEmail,
        tone: Number(toneSlider.value),
        length: Number(lengthSlider.value),
        career_level: levelChecks.filter((c) => c.checked).map((c) => c.value),
        employment_status: statusRadios.find((r) => r.checked)?.value || ""
      };
      try{
        await postJson("/u01", u01Payload);
        await postJson("/preferences", prefPayload);
        store.u01 = { createdAt: new Date().toISOString() };
        UIStore.save(store);
        window.location.href = "casefile_new.html";
      } catch (err){
        alert(err?.message || "Could not save your profile. Please try again.");
      }
    });
  </script>
  <style>
    .press-invert:active{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .press-invert.primary:active{
      background:#fff;
      color:var(--accent);
      border-color:var(--accent);
    }
  </style>
</body>
</html>
