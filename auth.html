<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SignalBench beta | Auth</title>
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon/favicon-16x16.png" />
  <link rel="apple-touch-icon" href="icons/favicon/apple-touch-icon.png" />
  <link rel="manifest" href="icons/favicon/site.webmanifest" />
  <link rel="stylesheet" href="ui_shell.css" />
  <script src="ui_theme.js"></script>
  <script src="ui_store.js"></script>
  <script src="ui_guard.js"></script>
</head>
<body data-page="auth">
  <!--
    Integration Notes (Auth)
    - Create account: invite_key + email + password (>=8, confirm match)
    - Sign in: email + password
    - On success: getMe -> route to /onboarding if U01 missing, else /app
  -->
  <div class="wrap">
    <div class="page">
                  <header class="page-header">
        <div class="brand large">
          <div class="brand-menu">
            <button class="brand-logo" type="button" aria-label="Open navigation">
              <img src="icons/logo1_round_80.png" alt="SignalBench logo" />
            </button>
            <div class="brand-panel" role="menu">

          <a href="landing.html" role="menuitem">Landing</a>
          <a href="auth.html" role="menuitem">Auth</a>
          <a href="onboarding.html" role="menuitem">Onboarding</a>
          <a href="casefile_new.html" role="menuitem">Casefile Setup</a>
          <a href="app.html" role="menuitem">App</a>
          <a href="settings.html" role="menuitem">Settings</a>
          <a href="feedback.html" role="menuitem">Feedback</a>
            </div>
          </div>
          <span class="brand-name">SignalBench</span>
        </div>
      </header>

      <main class="page-body">
        <section class="card">
          <h1 class="title">Create account</h1>
          <p class="subtitle">Invite‑only access for the private beta.</p>
          <form id="createForm" style="margin-top:12px;">
            <div class="row">
              <label class="field" style="flex:1">
                <span>Private beta invite key</span>
                <input id="inviteKey" type="text" placeholder="6-12 character key" maxlength="12" />
              </label>
              <label class="field" style="flex:1">
                <span>Email</span>
                <input id="createEmail" type="email" placeholder="you@email.com" required />
              </label>
            </div>
            <div class="row" style="margin-top:12px;">
              <label class="field" style="flex:1">
                <span>Create password (min 8 characters)</span>
                <input id="createPass" type="password" placeholder="••••••••" required />
              </label>
              <label class="field" style="flex:1">
                <span>Confirm password</span>
                <input id="createPassConfirm" type="password" placeholder="••••••••" required />
              </label>
            </div>
            <div class="row" style="margin-top:12px;">
              <button class="btn primary" id="btnCreateAccount" type="submit" disabled>Create Account</button>
            </div>
          </form>
          <div class="note" id="createNote"></div>
        </section>

        <section class="card">
          <h2 class="title" style="font-size:22px;">Sign in</h2>
          <form id="signInForm" style="margin-top:12px;">
            <div class="row">
              <label class="field" style="flex:1">
                <span>Email</span>
                <input id="signinEmail" type="email" placeholder="you@email.com" required />
              </label>
              <label class="field" style="flex:1">
                <span>Password</span>
                <input id="signinPass" type="password" placeholder="••••••••" required />
              </label>
            </div>
            <div class="row" style="margin-top:12px;">
              <button class="btn primary" type="submit">Sign In</button>
            </div>
          </form>
          <p class="note">Password auth only for Beta 1. No SSO.</p>
          <div class="note" id="signInNote"></div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const inviteKey = document.getElementById("inviteKey");
    const createEmail = document.getElementById("createEmail");
    const createPass = document.getElementById("createPass");
    const createPassConfirm = document.getElementById("createPassConfirm");
    const btnCreate = document.getElementById("btnCreateAccount");
    const createForm = document.getElementById("createForm");
    const signInForm = document.getElementById("signInForm");
    const createNote = document.getElementById("createNote");
    const signInNote = document.getElementById("signInNote");

    const isInviteValid = () => /^[A-Za-z0-9]{6,12}$/.test(inviteKey.value.trim());
    const isPassValid = () => createPass.value.length >= 8;
    const isPassMatch = () => createPass.value && createPass.value === createPassConfirm.value;

    const updateCreateState = () => {
      const ok = isInviteValid() && isPassValid() && isPassMatch() && createEmail.value.trim();
      btnCreate.disabled = !ok;
    };

    [inviteKey, createEmail, createPass, createPassConfirm].forEach((el) => {
      el.addEventListener("input", updateCreateState);
    });

    const API_BASE = "https://api.signal-bench.com";
    const postJson = async (path, payload) => {
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload || {})
      });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch (_err){ data = { raw: text }; }
      if (!res.ok){
        const msg = data.detail || data.error || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    };

    createForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const store = UIStore.load();
      const email = createEmail.value.trim();
      try{
        const resp = await postJson("/users", { user_email: email });
        const userId = resp.user_id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
        store.me = { id: userId, email };
        store.orch = store.orch || { userId, caseMap: {} };
        store.orch.userId = userId;
        store.auth = { isAuthed: true, inviteKey: inviteKey.value.trim() };
        UIStore.save(store);
        if (createNote) createNote.textContent = "Account created. Continuing to onboarding…";
        window.location.href = "onboarding.html";
      } catch (err){
        if (createNote) createNote.textContent = err?.message || "Could not create account.";
      }
    });
    signInForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const store = UIStore.load();
      const email = signinEmail.value.trim();
      try{
        const resp = await postJson("/users", { user_email: email });
        const userId = resp.user_id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
        store.me = store.me || { id: userId, email };
        store.me.id = userId;
        if (!store.me.email) store.me.email = email;
        store.orch = store.orch || { userId, caseMap: {} };
        store.orch.userId = userId;
        store.auth = { ...(store.auth || {}), isAuthed: true };
        UIStore.save(store);
        if (signInNote) signInNote.textContent = "Signed in. Continuing…";
        window.location.href = store.u01 ? "app.html" : "onboarding.html";
      } catch (err){
        if (signInNote) signInNote.textContent = err?.message || "Could not sign in.";
      }
    });
  </script>


  <script>
    document.querySelectorAll(".brand-menu").forEach((menu) => {
      const trigger = menu.querySelector(".brand-logo");
      if (!trigger) return;
      trigger.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      });
    });
    document.addEventListener("click", (e) => {
      document.querySelectorAll(".brand-menu.open").forEach((menu) => {
        if (!menu.contains(e.target)) menu.classList.remove("open");
      });
    });
  </script>
</body>
</html>
