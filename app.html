<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SignalBench beta | App</title>
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon/favicon-16x16.png" />
  <link rel="apple-touch-icon" href="icons/favicon/apple-touch-icon.png" />
  <link rel="manifest" href="icons/favicon/site.webmanifest" />
  <link rel="stylesheet" href="ui_shell.css" />
  <script src="ui_theme.js"></script>
  <script src="ui_store.js"></script>
  <script src="ui_guard.js?v=2026-02-28"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Ibarra+Real+Nova:wght@500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap');

    :root{
      --bg:#f7f3ee;
      --ink:#1d232a;
      --muted:#5f6b73;
      --line:#c9c3bb;
      --soft:#e6dfd6;
      --panel:#fbf9f6;
      --active:#efe6da;
      --accent:#0f5f63;
      --radius:10px;

      --sans: "Source Sans 3", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      --serif: "Ibarra Real Nova", Georgia, "Times New Roman", serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg, #f7f3ee 0%, #f0ece6 100%);
      color:var(--ink);
      font-family:var(--sans);
    }
        
    /* App window */
    .wrap{
      height:100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:16px;
      width:100%;
    }
    .app{
      width:100%;
      max-width:none;
      border:1px solid var(--line);
      display:grid;
      grid-template-columns: 280px minmax(0, 1fr);
      grid-template-rows: 1fr;
      background:var(--panel);
      box-shadow:0 18px 40px rgba(29,35,42,.08);
      border-radius:16px;
      overflow:hidden;
    }
    @media (max-width: 768px){
      .wrap{padding:4px;}
      .app{border-radius:12px;}
      aside{display:none !important;}
      .app{grid-template-columns: 1fr !important;}
    }
    @media (min-width: 1024px){
      aside{display:flex;}
      .app{grid-template-columns: 280px minmax(0, 1fr);}
    }

    /* Title bar (in-app, not browser tab) */
    .titlebar{
      grid-column:1/-1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      letter-spacing:.2px;
      font-size:var(--fs-24);
      font-family:var(--serif);
    }
    .brand small{
      font-weight:700;
      color:var(--muted);
      margin-left:6px;
      font-size:var(--fs-14);
    }
    .mark{
      display:flex;
      align-items:flex-end;
      gap:2px;
      height:18px;
    }
    .bar{width:4px;background:#111;border-radius:2px}
    .bar:nth-child(1){height:8px}
    .bar:nth-child(2){height:12px}
    .bar:nth-child(3){height:16px}
    .tie{
      height:16px;
      width:6px;
      background:#fff;
      border:2px solid #111;
      border-radius:3px;
      margin-left:2px;
    }

    .win-controls{
      display:flex;
      gap:10px;
      align-items:center;
      user-select:none;
      font-family:var(--mono);
      font-weight:900;
    }
    .ctrl{
      width:18px;height:18px;border:1px solid #111; display:grid; place-items:center;
      font-size:var(--fs-12); line-height:1;
    }
    .ctrl.min{border:none;width:auto}
    .ctrl.min::before{content:"—";}
    .ctrl.max{background:#fff}
    .ctrl.close{border:none;width:auto}
    .ctrl.close::before{content:"X";}

    /* Sidebar */
    aside{
      grid-row:1;
      border-right:none;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .sidebar-top{
      padding:14px 12px;
    }
    .sidebar-brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-family:var(--serif);
      font-size:var(--fs-28);
      font-weight:700;
      margin-bottom:16px;
      color:inherit;
    }
    .sidebar-brand img{
      width:40px;
      height:40px;
      border-radius:50%;
      display:block;
    }
    .sidebar-title{
      font-weight:900;
      font-size:var(--fs-14);
      margin:0 0 10px 0;
    }
    .new-casefile{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size:var(--fs-14);
      cursor:pointer;
      background:transparent;
      border:none;
      padding:0;
      color:#111;
    }

    /* Dark theme overrides */
    [data-theme="batman"] aside,
    [data-theme="batman"] .sidebar-top,
    [data-theme="batman"] .stages{
      background:var(--bg);
      color:var(--ink);
    }
    [data-theme="batman"] .sidebar-brand span,
    [data-theme="batman"] .new-casefile,
    [data-theme="batman"] details.stage > summary,
    [data-theme="batman"] .case-link{
      color:var(--ink);
    }
    [data-theme="batman"] details.stage[open] > summary,
    [data-theme="batman"] details.stage.empty > summary,
    [data-theme="batman"] details.stage.active-open > summary,
    [data-theme="batman"] details.stage.has-items{
      background:#7f7f7f;
      border-color:#7f7f7f;
    }
    [data-theme="batman"] details.stage > summary{
      background:#7f7f7f !important;
      border-color:#7f7f7f !important;
    }
    [data-theme="batman"] details.stage:not(.has-items) > summary{
      background:#7f7f7f;
      border-color:#7f7f7f;
    }
    [data-theme="batman"] details.stage.has-items > summary{
      background:transparent;
    }
    [data-theme="batman"] .case-link{
      background:#bfbfbf;
      border-color:#bfbfbf;
      color:#fff;
    }
    [data-theme="batman"] .case-link.active{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    [data-theme="batman"] .case-link:hover{
      background:#bfbfbf;
    }
    [data-theme="batman"] .count{
      color:#fff;
    }
    [data-theme="batman"] .chat,
    [data-theme="batman"] .chat-empty{
      background:#bfbfbf;
      border-color:#bfbfbf;
      color:#fff;
    }
    [data-theme="batman"] .msg{
      background:#595959;
      border-color:#595959;
      color:#fff;
    }
    [data-theme="batman"] .msg.user{
      background:#f2f2f2;
      border-color:#f2f2f2;
      color:#000;
    }
    [data-theme="batman"] .composer-shell{
      background:#7f7f7f;
      border-color:#7f7f7f;
    }
    [data-theme="batman"] .compass-pill{
      background:#bfbfbf;
      border-color:#bfbfbf;
      color:#000;
    }
    [data-theme="batman"] .compass-pill.active{
      background:#bfbfbf;
      border-color:#000;
      color:#000;
    }
    [data-theme="batman"] .compass-label,
    [data-theme="batman"] .compass-top,
    [data-theme="batman"] .compass-top .right{
      color:#fff;
    }
    [data-theme="batman"] .compass-top .compass-meta{
      color:#d6d6d6;
    }
    [data-theme="batman"] .compass-actions{
      color:#000;
    }
    [data-theme="batman"] #msg{
      color:#000;
    }
    [data-theme="batman"] #msg::placeholder{
      color:#000;
    }

    .stages{
      padding:10px 8px 12px 8px;
      overflow:auto;
      min-height:0;
    }

    details.stage{
      border:none;
      margin:10px 0;
    }
    details.stage > summary{
      list-style:none;
      cursor:pointer;
      font-weight:900;
      padding:8px 8px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    details.stage > summary::-webkit-details-marker{display:none;}
    details.stage[open] > summary{background:#fff;}
    .count{
      font-weight:800;
      color:var(--muted);
      font-size:var(--fs-12);
      padding-left:10px;
    }
    .case-list{
      margin:0;
      padding:6px 0 8px 0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
    }
    .case-link{
      width:auto;
      min-width:80%;
      max-width:94%;
      text-align:left;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--soft);
      background:#f4efe8;
      cursor:pointer;
      font-weight:500;
      color:#111;
    }
    .case-link:hover{background:var(--panel)}
    .case-link.active{
      background:var(--active);
      border-color:var(--ink);
      color:var(--ink);
      font-weight:800;
    }
    .drop-target{
      outline:2px dashed #111;
      outline-offset:2px;
    }
    details.stage.empty > summary{
      background:#fff;
      border:1px solid var(--soft);
      border-radius:999px;
      padding:6px 10px;
    }
    details.stage.active-folded > summary{
      background:var(--active);
      border:1px solid var(--line);
    }
    details.stage.has-items{
      background:#fff;
      border:1px solid var(--soft);
      border-radius:20px;
      padding:6px 8px 8px 8px;
      margin-bottom:22px;
    }
    details.stage.active-folded,
    details.stage.active-open{
      box-shadow:0 12px 22px rgba(29,35,42,.12);
    }
    details.stage.active-open.has-items{
      box-shadow:0 12px 22px rgba(29,35,42,.12);
    }
    details.stage.active-open > summary{
      background:#fff;
      border:1px solid var(--soft);
    }
    details.stage.has-items > summary{
      border-radius:14px;
      padding:6px 10px;
      margin-bottom:2px;
      border:none;
    }
    details.stage.has-items:not([open]) > summary{
      background:#fff;
      border:1px solid var(--soft);
      border-radius:999px;
      padding:6px 10px;
      margin-bottom:0;
    }
    details.stage.has-items .case-list{
      background:transparent;
      border:none;
      border-radius:0 0 16px 16px;
      padding:6px 0 8px 0;
    }

    /* Profile card */
    .profile-card{
      margin-top:auto;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-start;
      position:relative;
    }
    .avatar{
      width:44px;height:44px;border-radius:50%;
      overflow:hidden;
      border:1px solid #999;
      flex:0 0 auto;
      background:#fff;
    }
    .avatar img{width:100%;height:100%;display:block}
    .pc-meta{min-width:0;display:flex;flex-direction:column;gap:4px;flex:1}
    .pc-name{
      font-weight:900;
      line-height:1.2;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
    .pc-tier{font-weight:700;color:var(--muted)}
    .pc-gear-wrap{
      position:static;
      margin-left:auto;
    }
    .pc-menu{
      position:absolute;
      left:12px;
      bottom:calc(100% + 6px);
      display:none;
      flex-direction:column;
      gap:6px;
      background:#fff;
      border:1px solid var(--soft);
      border-radius:12px;
      padding:8px 10px;
      box-shadow:0 10px 24px rgba(29,35,42,.12);
      min-width:160px;
      z-index:20;
    }
    .brand-panel .menu-divider{
      height:1px;
      background:var(--soft);
      margin:4px 0;
      width:100%;
    }
    .brand-panel button,
    .brand-panel a{
      background:transparent; border:none; padding:0; cursor:pointer; font:inherit;
      color:#111; display:flex; gap:6px; align-items:center;
      text-align:left;
      font-size:var(--fs-14);
      font-weight:600;
      font-family:var(--sans);
      text-decoration:none;
    }
    .pc-gear-wrap.open .pc-menu{
      display:flex;
    }
    .pc-menu button,
    .pc-menu a{
      background:transparent; border:none; padding:0; cursor:pointer; font:inherit;
      color:#111; display:flex; gap:6px; align-items:center;
      text-align:left;
      font-size:var(--fs-14);
      font-weight:600;
      font-family:var(--sans);
      text-decoration:none;
      
    }
    .pc-menu .menu-divider{
      height:1px;
      background:var(--soft);
      margin:4px 0;
      width:100%;
    }
    .pc-menu button.active{
      font-weight:800;
    }
    .pc-user{
      display:flex;
      gap:10px;
      align-items:center;
      cursor:pointer;
    }
    .case-link:focus-visible,
    .compass-pill:focus-visible,
    .pc-gear:focus-visible,
    .brand-logo:focus-visible,
    .btn:focus-visible,
    .new-casefile:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }


    /* Main area */
    main{
      grid-row:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .row{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .label{font-weight:700}
    .value{font-weight:600}

    /* Chat container */
    .chat{
      flex:1 1 auto;
      min-height:0;
      border-top:0;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      padding:14px;
      gap:12px;
      overflow-y:auto;
      background:#fff;
      border:1px solid var(--line);
      border-radius:0 16px 0 16px;
    }
    .chat-empty{
      flex:1 1 auto;
      border:1px dashed var(--line);
      border-radius:14px;
      background:var(--panel);
      padding:16px;
      color:var(--muted);
      font-size:var(--fs-14);
      display:flex;
      align-items:center;
    }
    .messages{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:auto;
    }
    .msg{
      max-width:72%;
      padding:10px 12px;
      border-radius:14px;
      line-height:1.4;
      font-size:var(--fs-14);
      border:1px solid var(--soft);
      background:#fff;
    }
    .msg.user{
      align-self:flex-end;
      background:var(--active);
      border-color:var(--line);
    }
    .msg.assistant{
      align-self:flex-start;
    }
    .msg.readonly{
      max-width:100%;
      width:100%;
    }
    .msg.assistant h1,
    .msg.assistant h2,
    .msg.assistant h3{
      margin:6px 0;
      font-size:var(--fs-14);
      font-weight:700;
    }
    .msg.assistant p{
      margin:6px 0;
    }
    .msg.assistant ul,
    .msg.assistant ol{
      margin:6px 0 6px 18px;
      padding:0;
    }
    .msg.assistant li{
      margin:4px 0;
    }
    .msg.assistant code{
      font-family:var(--mono);
      font-size:12px;
      background:var(--panel);
      padding:1px 4px;
      border-radius:6px;
    }
    .msg.assistant pre{
      margin:6px 0;
      padding:8px 10px;
      background:var(--panel);
      border-radius:8px;
      overflow:auto;
    }
    .typing{
      display:none;
      font-size:var(--fs-12);
      color:var(--muted);
    }
    .markdown-view{
      flex:1 1 auto;
      min-height:0;
      padding:14px;
      overflow:auto;
      background:#fff;
    }
    .md-shell{
      border:1px solid var(--line);
      border-radius:2px;
      background:var(--panel);
      padding:12px;
      font-family:var(--mono);
      font-size:var(--fs-14);
      white-space:pre-wrap;
      line-height:1.5;
    }

    /* Composer */
    .composer{
      padding:10px 14px 12px 0;
      border-top:none;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .composer-shell{
      border:1px solid var(--soft);
      border-radius:20px;
      padding:10px 12px;
      background:#fff;
      box-shadow:0 12px 22px rgba(29,35,42,.12);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .inputbar{
      display:flex;
      align-items:center;
      gap:10px;
      border:none;
      border-radius:0;
      padding:6px 0 2px 0;
      background:transparent;
      box-shadow:none;
    }
    .btn{
      width:32px;height:32px;border-radius:999px;
      border:1px solid var(--soft);
      display:grid; place-items:center;
      cursor:pointer;
      background:#fff;
      font-weight:900;
      user-select:none;
    }
    .btn:hover{background:var(--panel)}
    .btn.icon{
      font-family:var(--mono);
      font-weight:900;
    }
    .btn.wave{
      border-color:var(--accent);
      background:var(--accent);
      color:#fff;
    }
    .btn.wave:hover{background:#0c5256}
    #msg{
      border:none;
      outline:none;
      flex:1 1 auto;
      font-family:var(--sans);
      font-size:var(--fs-14);
      font-weight:400;
      color:var(--ink);
      line-height:1.4;
      resize:none;
      overflow-y:hidden;
      min-height:2.6em;
      max-height:14.5em;
      padding:6px 0;
      background:transparent;
    }
    #msg::placeholder{
      color:var(--muted);
    }
    .hint{
      display:flex;
      gap:10px;
      color:var(--muted);
      font-size:var(--fs-14);
      justify-content:center;
      text-align:center;
    }

    .compass{
      border:none;
      border-radius:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:8px;
      background:transparent;
      box-shadow:none;
    }
    .compass-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size:var(--fs-15);
      font-weight:600;
    }
    .compass-top .right{
      margin-left:auto;
      text-align:right;
      color:var(--ink);
      font-weight:600;
      font-size:var(--fs-14);
    }
    .compass-top .compass-meta{
      color:var(--muted);
      font-weight:500;
    }
    .compass-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .compass-label{
      font-family:var(--sans);
      font-size:var(--fs-14);
      color:var(--muted);
      font-weight:400;
    }
    .compass-steps{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      font-size:var(--fs-14);
    }
    .compass-pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:4px 10px;
      background:var(--panel);
      cursor:pointer;
      font-family:var(--sans);
      font-size:var(--fs-14);
      font-weight:400;
    }
    .compass-pill.active{
      background:var(--active);
      border-color:var(--ink);
      color:var(--ink);
      font-weight:700;
    }
    .compass-actions{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:12px;
      font-family:var(--sans);
      font-size:var(--fs-14);
      font-weight:400;
    }
    .compass-clear{
      color:var(--muted);
    }

    .guard-banner{
      position:fixed;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      color:#fff;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:var(--fs-12);
      z-index:2000;
      display:none;
    }
    .toast{
      position:fixed;
      bottom:20px;
      right:20px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      font-size:var(--fs-14);
      box-shadow:0 10px 24px rgba(29,35,42,.08);
      display:none;
      z-index:2000;
    }
    .guarded{
      filter:blur(2px);
      pointer-events:none;
      user-select:none;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(520px, 100%);
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px;
    }
    .modal h3{margin:0 0 10px 0; font-size:var(--fs-18)}
    .modal .modal-sub{margin:-6px 0 10px 0; font-size:12px; color:var(--muted)}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-weight:900;
      font-size:var(--fs-14);
    }
    .field input{
      border:1px solid #d1d5db;
      border-radius:8px;
      padding:10px;
      font-size:var(--fs-14);
      font-weight:700;
    }
    .modal-actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
    .action{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--line);
      background:var(--panel);
      font-weight:900;
      cursor:pointer;
    }
    .action.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .action:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

  </style>
</head>

<body data-page="app">
  <!--
    Integration Notes (App)
    - On load: getMe, listCasefilesByStage, getMessages(activeCase)
    - Send message: DataAdapter.sendMessage(caseId, payload) -> Orchestrator
    - Drag stage: DataAdapter.updateCasefileStage(caseId, stage)
  -->
  <div class="guard-banner" id="guardBanner">Guard active: redirecting to auth/onboarding (demo only)</div>
  <div class="toast" id="toast"></div>
  <div class="wrap">
    <div class="app" role="application" aria-label="SignalBench beta v0.1">

      <!-- Sidebar -->
      <aside>
        <div class="sidebar-top">
          <div class="sidebar-brand">
            <div class="brand-menu">
              <button class="brand-logo" type="button" aria-label="Open navigation">
                <img src="icons/logo1_round_44.png" alt="SignalBench logo" />
              </button>
              <div class="brand-panel" role="menu">
              <a href="help.html" role="menuitem" target="_blank" rel="noopener noreferrer">Help</a>
              <a href="settings.html" role="menuitem">Settings</a>
              <a href="feedback.html" role="menuitem">Feedback</a>
              <div class="menu-divider" role="separator"></div>
              <button id="btnProfileMenu" type="button" role="menuitem">My Profile</button>
              <button id="btnStoryMenu" type="button" role="menuitem">My Storybook</button>
              <a href="https://signalbench.cloudflareaccess.com/cdn-cgi/access/logout" role="menuitem" data-logout="true">Logout</a>
            </div>
            </div>
            <span>SignalBench</span>
          </div>
          <button class="new-casefile" id="btnNewCasefile" type="button">+ New Casefile</button>
        </div>

        <div class="stages" id="stages">
          <!-- FOLD/UNFOLD: use <details> per stage -->
          <details class="stage" open data-stage="screen">
            <summary>
              <span>Screen</span>
              <span class="count" id="count-screen">0</span>
            </summary>
            <ul class="case-list" id="list-screen"></ul>
          </details>

          <details class="stage" open data-stage="validate">
            <summary>
              <span>Pursue</span>
              <span class="count" id="count-validate">0</span>
            </summary>
            <ul class="case-list" id="list-validate"></ul>
          </details>

          <details class="stage" open data-stage="prepare">
            <summary>
              <span>Interview</span>
              <span class="count" id="count-prepare">0</span>
            </summary>
            <ul class="case-list" id="list-prepare"></ul>
          </details>

          <details class="stage" open data-stage="advance">
            <summary>
              <span>Offer</span>
              <span class="count" id="count-advance">0</span>
            </summary>
            <ul class="case-list" id="list-advance"></ul>
          </details>

          <details class="stage" open data-stage="launch">
            <summary>
              <span>Transition</span>
              <span class="count" id="count-launch">0</span>
            </summary>
            <ul class="case-list" id="list-launch"></ul>
          </details>

          <details class="stage" open data-stage="closed">
            <summary>
              <span>Close</span>
              <span class="count" id="count-closed">0</span>
            </summary>
            <ul class="case-list" id="list-closed"></ul>
          </details>
        </div>

        <div class="profile-card">
          <div class="pc-user">
            <div class="avatar">
              <img id="profileAvatar" src="icons/avatar_default.svg" alt="User avatar" />
            </div>
            <div class="pc-meta">
              <div class="pc-name" id="profileName">New User</div>
              <div class="pc-tier">Executive Tier</div>
            </div>
          </div>
          <div class="pc-gear-wrap">
            <div class="pc-menu" role="menu" aria-label="Profile menu">
              <a href="help.html" role="menuitem" target="_blank" rel="noopener noreferrer">Help</a>
              <a href="settings.html" role="menuitem">Settings</a>
              <a href="feedback.html" role="menuitem">Feedback</a>
              <div class="menu-divider" role="separator"></div>
              <button id="btnProfile" type="button" role="menuitem">My Profile</button>
              <button id="btnStory" type="button" role="menuitem">My Storybook</button>
              <a href="https://signalbench.cloudflareaccess.com/cdn-cgi/access/logout" role="menuitem" data-logout="true">Logout</a>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main>
        <section class="chat" id="chat" aria-label="Chat">
          <div class="chat-empty" id="chatEmpty">
            No messages yet. Start with a common next step or ask a question to begin.
          </div>
          <div class="messages" id="messages" aria-live="polite"></div>
          <div class="typing" id="typing">Assistant is typing…</div>
        </section>

        <section class="markdown-view" id="markdownView" aria-label="Read-only Markdown" style="display:none;">
          <div class="md-shell" id="markdownContent"></div>
        </section>

        <div class="composer" aria-label="Composer">
          <div class="composer-shell">
            <div class="compass" id="compass">
              <div class="compass-top">
                <span id="compassActive">No active casefile selected</span>
                <span class="right compass-meta" id="compassStageMeta">System State: —</span>
              </div>
              <div class="compass-actions">
                <span class="compass-label">Next, we can:</span>
                <span class="compass-steps" id="compassSteps"></span>
                
              </div>
            </div>

            <div class="inputbar">
              <!-- Attach (eventual file picker) -->
              <button class="btn icon" id="btnAttach" type="button" aria-label="Attach">+</button>

              <!-- Main text input -->
              <textarea id="msg" rows="2" placeholder="... or you can continue freeform here" autocomplete="off"></textarea>
            </div>
          </div>

          <div class="hint" style="font-size:10px;">
            <span>Beta software for testing and feedback. Share issues or ideas via <a href="feedback.html">Feedback</a>. © 2026 SignalBench LLC. All rights reserved.</span>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- New Casefile Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="Create new casefile">
    <div class="modal">
      <h3 id="casefileModalTitle">New Casefile</h3>
      <div class="modal-sub" id="casefileModalHint"></div>

      <div class="grid">
        <label class="field">
          <span>Role</span>
          <input id="inputRole" type="text" placeholder="e.g. VP Operations" />
        </label>
        <label class="field">
          <span>Company</span>
          <input id="inputCompany" type="text" placeholder="e.g. Amazon" />
        </label>
      </div>

      <div class="modal-actions">
        <button class="action" id="btnCancel" type="button">Cancel</button>
        <button class="action primary" id="btnCreate" type="button" disabled>Create</button>
      </div>
    </div>
  </div>

  <script>
    /**
     * UI Shell behavior only:
     * - Create new casefile into Screen stage
     * - Selecting a casefile sets Active Casefile header
     * - Fold/unfold per stage is native via <details>
     * - No persistence; state resets on refresh
     */

    const API_BASE = window.SB_API_BASE || "/api";

    (() => {
      const store = UIStore.load();
      if (!store.me){
        const id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
        store.me = { id, email: null };
      }
      if (!store.orch) store.orch = { userId: null, caseMap: {} };
      if (!store.orch.caseMap) store.orch.caseMap = {};
      UIStore.save(store);
    })();


    const MockAdapter = (() => {
      let store = UIStore.load();

      const persist = () => UIStore.save(store);

      return {
        // Adapter contract (UI -> Orchestrator/SQL)
        // getMe() -> {id, email}
        // createU01({ fullName, email, resumeRaw, resumeText? }) -> U01
        // createCasefile({ role, company, stage }) -> casefile
        // createU03(caseId, { jdRaw, jdText? }) -> U03
        // listCasefilesByStage() -> casefile[]
        // getMessages(caseId) -> message[]
        // sendMessage(caseId, {id, role, content, createdAt}) -> message
        // updateCasefileStage(caseId, stage) -> void
        getMe(){
          return store.me;
        },
        createU01(payload){
          store.u01 = { ...payload, createdAt: new Date().toISOString() };
          persist();
          return store.u01;
        },
        createCasefile(payload){
          const cf = {
            id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
            role: payload.role,
            company: payload.company,
            stage: payload.stage || "screen"
          };
          store.casefiles.push(cf);
          persist();
          return cf;
        },
        createU03(caseId, payload){
          store.u03 = store.u03 || {};
          store.u03[caseId] = { ...payload, createdAt: new Date().toISOString() };
          persist();
          return store.u03[caseId];
        },
        listCasefilesByStage(){
          return [...store.casefiles];
        },
        setActiveCasefile(caseId){
          store.activeCaseId = caseId;
          persist();
        },
        getActiveCasefile(){
          return store.activeCaseId;
        },
        updateCasefileStage(caseId, stage){
          const cf = store.casefiles.find(c => c.id === caseId);
          if (!cf) return;
          cf.stage = stage;
          persist();
          console.log("[DataAdapter] updateCasefileStage", { caseId, stage });
        },
        getMessages(caseId){
          return store.messages[caseId] ? [...store.messages[caseId]] : [];
        },
        sendMessage(caseId, payload){
          if (!store.messages[caseId]) store.messages[caseId] = [];
          store.messages[caseId].push(payload);
          persist();
          return payload;
        }
      };
    })();

    const ApiAdapter = (local) => {
      const postJson = async (path, payload) => {
        const res = await fetch(`${API_BASE}${path}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload || {})
        });
        const text = await res.text();
        let data = {};
        try {
          data = text ? JSON.parse(text) : {};
        } catch (_err) {
          data = { raw: text };
        }
        if (!res.ok){
          const msg = data.detail || data.error || `HTTP ${res.status}`;
          throw new Error(msg);
        }
        return data;
      };
      const getJson = async (path) => {
        const res = await fetch(`${API_BASE}${path}`, { credentials: "include" });
        const text = await res.text();
        let data = {};
        try {
          data = text ? JSON.parse(text) : {};
        } catch (_err) {
          data = { raw: text };
        }
        if (!res.ok){
          const msg = data.detail || data.error || `HTTP ${res.status}`;
          throw new Error(msg);
        }
        return data;
      };

      const normalizeStage = (value) => {
        const s = String(value || "").toLowerCase();
        const allowed = ["screen", "validate", "prepare", "advance", "launch", "closed"];
        return allowed.includes(s) ? s : "screen";
      };

      const mapCasefiles = (rows) => {
        return (rows || [])
          .map((row) => ({
            id: row.case_id || row.id || "",
            role: row.role_title || "",
            company: row.company_name || "",
            stage: normalizeStage(row.active_state || row.status || "screen"),
            title: row.title || ""
          }))
          .filter((row) => row.id);
      };

      return {
        ...local,
        setActiveCasefile(caseId){
          const store = UIStore.load();
          store.activeCaseId = caseId;
          UIStore.save(store);
          return caseId;
        },
        getActiveCasefile(){
          const store = UIStore.load();
          return store.activeCaseId || null;
        },
        sendTurn(payload){
          return postJson("/turn", payload);
        },
        getMessages(localCaseId){
          const store = UIStore.load();
          const orch = store.orch || { caseMap: {} };
          const serverCaseId = orch.caseMap?.[localCaseId] || localCaseId;
          if (!serverCaseId){
            return local.getMessages(localCaseId);
          }
          return getJson(`/messages?case_id=${encodeURIComponent(serverCaseId)}&limit=40`)
            .then((resp) => Array.isArray(resp.messages) ? resp.messages : []);
        },
        async listCasefilesByStage(){
          try{
            const resp = await getJson("/casefiles");
            const rows = Array.isArray(resp.casefiles) ? resp.casefiles : [];
            const mapped = mapCasefiles(rows);
            const store = UIStore.load();
            store.casefiles = mapped;
            store.orch = store.orch || { userId: store.orch?.userId || store.me?.id || null, caseMap: {} };
            store.orch.caseMap = store.orch.caseMap || {};
            mapped.forEach((cf) => {
              store.orch.caseMap[cf.id] = cf.id;
            });
            UIStore.save(store);
            return mapped;
          } catch (_err){
            return local.listCasefilesByStage();
          }
        },
        async createCasefile(payload){
          const store = UIStore.load();
          const role = payload?.role || "";
          const company = payload?.company || "";
          const stage = payload?.stage || "screen";
          const userId = store.orch?.userId || store.me?.id || null;
          const userEmail = store.me?.email || "";
          const title = payload?.title || (role && company ? `${role} @ ${company}` : role || company || "New Casefile");
          const createPayload = {
            user_id: userId,
            user_email: userEmail,
            title,
            company_name: company,
            role_title: role,
            stage
          };
          try{
            const resp = await postJson("/casefiles", createPayload);
            const serverCaseId = resp.case_id || resp.casefile_id || null;
            const cf = {
              id: serverCaseId || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2)),
              role,
              company,
              stage
            };
            store.casefiles = store.casefiles || [];
            store.casefiles.push(cf);
            store.orch = store.orch || { userId: userId, caseMap: {} };
            store.orch.caseMap = store.orch.caseMap || {};
            store.orch.caseMap[cf.id] = serverCaseId || cf.id;
            UIStore.save(store);
            return cf;
          } catch (_err){
            return local.createCasefile(payload);
          }
        },
        updateCasefileStage(caseId, stage){
          const store = UIStore.load();
          store.casefiles = store.casefiles || [];
          const cf = store.casefiles.find(c => c.id === caseId);
          if (cf){
            cf.stage = stage;
          }
          UIStore.save(store);
          return cf;
        },
        getU01(){
          const store = UIStore.load();
          const userId = store.orch?.userId || store.me?.id || "";
          const email = store.me?.email || "";
          const qs = userId ? `?user_id=${encodeURIComponent(userId)}` : `?user_email=${encodeURIComponent(email)}`;
          return getJson(`/u01${qs}`);
        },
        getU02(){
          const store = UIStore.load();
          const userId = store.orch?.userId || store.me?.id || "";
          const email = store.me?.email || "";
          const qs = userId ? `?user_id=${encodeURIComponent(userId)}&limit=50` : `?user_email=${encodeURIComponent(email)}&limit=50`;
          return getJson(`/u02${qs}`);
        }
      };
    };

    const DataAdapter = ApiAdapter(MockAdapter);

    const state = {
      activeCaseId: null,
      activeView: "casefile", // casefile | profile | storybook
      casefiles: [], // {id, role, company, stage}
      messages: [],
      scrollMode: null, // "bottom" | "assistant-top"
      noCaseReminderCount: 0,
      activeStage: "Screen",
      systemState: null,
      intentKey: null,
      compass: {
        stage: "Screen",
        where: "No active casefile yet.",
        suggestedPrompt: "",
        steps: [],
        selectedStepLabel: null
      }
    };


    const COMPASS_CONFIG = {
      screen: {
        goal: "orient, extract requirements and decide whether to invest.",
        steps: [
          { label: "Deconstruct role", intent_key: "screen.deconstruct_role", seed_prompt: "Deconstruct this JD into real success outcomes." },
          { label: "Check fit", intent_key: "screen.check_fit_gaps", seed_prompt: "Assess my fit signals and misfit risks. Ask me questions that may close gaps and build out my Storybook." },
          { label: "Evaluate risks and opportunities", intent_key: "screen.evaluate_risks_opportunities", seed_prompt: "Identify downside risks and upside opportunities before I invest more time." }
        ]
      },
      validate: {
        goal: "establish truth sufficiency and build confidence through evidence.",
        steps: [
          { label: "Stress test", intent_key: "validate.stress_test", seed_prompt: "Challenge my claims against the JD requirements. Ask me questions that may close gaps and build out my Storybook." },
          { label: "Fill gaps", intent_key: "validate.fill_gaps", seed_prompt: "Tell me what evidence is missing and why. How might we fill the gaps?" },
          { label: "Prepare application", intent_key: "validate.prepare_application", seed_prompt: "Optimize my resume using Storybook facts for screening." }
        ]
      },
      prepare: {
        goal: "optimize signal expression inside known truth boundaries.",
        steps: [
          { label: "Build narrative spine", intent_key: "prepare.build_narrative_spine", seed_prompt: "Draft a narrative spine for this role to anchor what we know from the JD to what we might expect downstream." },
          { label: "Prepare stories", intent_key: "prepare.prepare_stories", seed_prompt: "Pick and develop my top 3-5 stories with me that will likely be asked in the interview. Ask me questions along the way." },
          { label: "Clarify signal", intent_key: "prepare.clarify_signal", seed_prompt: "Help me tighten my evidence-based signals without adding claims." }
        ]
      },
      advance: {
        goal: "learn and recalibrate as real interactions occur.",
        steps: [
          { label: "Debrief interview", intent_key: "advance.debrief_interview", seed_prompt: "Help me debrief: what happened & what it meant. I'll start with a narrative, then you ask necessary questions." },
          { label: "Update hypothesis", intent_key: "advance.update_hypothesis", seed_prompt: "Update employer intent, facts and hypotheses based on new signals from the interviews." },
          { label: "Draft follow-up", intent_key: "advance.draft_follow_up", seed_prompt: "Draft a tailored follow-up reinforcing key alignment." }
        ]
      },
      launch: {
        goal: "negotiate eyes-open; consolidate evidence; surface residual risk before acceptance.",
        steps: [
          { label: "Pressure test", intent_key: "launch.pressure_test", seed_prompt: "List top risks still unresolved before I accept." },
          { label: "Negotiate terms", intent_key: "launch.negotiate_terms", seed_prompt: "Help me negotiate comp, scope, and authority." },
          { label: "Plan entry", intent_key: "launch.plan_entry", seed_prompt: "Draft a 30-60-90 entry plan for this role. Include all facts, hypotheses and unknowns as well as cultural and personal insights." }
        ]
      },
      closed: {
        goal: "archived casefiles for reference.",
        steps: [
          { label: "Extract signals", intent_key: "closed.extract_signals", seed_prompt: "Extract reusable signals and stories for future roles." },
          { label: "Do retrospective", intent_key: "closed.do_retrospective", seed_prompt: "Reflect on what we learned through the journey of this casefile." }
        ]
      }
    };

    const el = (id) => document.getElementById(id);

    const appShell = document.querySelector(".app");
    const guardBanner = el("guardBanner");
    const toast = el("toast");
    const modalBackdrop = el("modalBackdrop");
    const modalTitle = el("casefileModalTitle");
    const modalHint = el("casefileModalHint");
    const btnNewCasefile = el("btnNewCasefile");
    const btnCancel = el("btnCancel");
    const btnCreate = el("btnCreate");

    const inputRole = el("inputRole");
    const inputCompany = el("inputCompany");

    const activeCasefile = null;
    const compassActive = el("compassActive");
    const compassStageMeta = el("compassStageMeta");
    const chat = el("chat");
    const chatEmpty = el("chatEmpty");
    const messagesEl = el("messages");
    const typingEl = el("typing");
    const markdownView = el("markdownView");
    const markdownContent = el("markdownContent");
    const composer = document.querySelector(".composer");
    const compassWhere = el("compassWhere");
    const compassSteps = el("compassSteps");
    const msgInput = el("msg");
    const btnClearDemo = el("btnClearDemo");

    const formatDate = (value) => {
      if (!value) return "";
      try{
        const d = new Date(value);
        if (Number.isNaN(d.getTime())) return String(value);
        return d.toISOString().slice(0, 10);
      } catch (_err){
        return String(value);
      }
    };

    const shortId = (value) => {
      if (!value) return "";
      const str = String(value);
      return str.length > 8 ? str.slice(0, 8) : str;
    };

    const buildProfileMarkdown = (u01) => {
      if (!u01){
        return "# U01 — Candidate Profile (Read Only)\n\nNo profile data found yet.";
      }
      const content = u01.content_json || u01;
      const name = content.full_name || content.name || "";
      const preferred = content.preferred_name || "";
      const email = content.email || "";
      const resume = content.resume_text || content.text || "";
      const createdAt = formatDate(u01.created_at || content.created_at);
      const lines = [
        "# U01 — Candidate Profile (Read Only)",
        "",
        name ? `- Full name: ${name}` : null,
        preferred ? `- Preferred name: ${preferred}` : null,
        email ? `- Email: ${email}` : null,
        createdAt ? `- Last updated: ${createdAt}` : null,
        "",
        "## Resume (Raw)",
        resume ? "```" : null,
        resume ? resume : null,
        resume ? "```" : null
      ].filter(Boolean);
      return lines.join("\n");
    };

    const buildStoryMarkdown = (stories) => {
      const cleaned = (stories || []).filter((story) => {
        const content = story.content_json || story;
        const text = String(content.text || content.story || content.notes || "").trim();
        if (!text) return false;
        if (text.toLowerCase() === "seeded") return false;
        return true;
      });
      if (!cleaned.length){
        return "# U02 — Storybook (Read Only)\n\nNo stories found yet.";
      }
      const lines = [
        "# U02 — Storybook (Read Only)",
        "",
        `Total stories: ${cleaned.length}`,
        "",
        "## Stories"
      ];
      cleaned.forEach((story, idx) => {
        const content = story.content_json || story;
        const text = content.text || content.story || content.notes || "";
        const createdAt = formatDate(story.created_at || content.created_at);
        const id = shortId(story.u02_id || story.story_id || "");
        lines.push(`${idx + 1}. **Story ${idx + 1}**${id ? ` (ID: ${id})` : ""}${createdAt ? ` — ${createdAt}` : ""}`);
        if (text){
          lines.push(text);
        }
        lines.push("");
      });
      return lines.join("\n");
    };

    const extractText = async (file) => {
      const form = new FormData();
      form.append("file", file);
      const res = await fetch(`${API_BASE}/extract_text`, {
        method: "POST",
        credentials: "include",
        body: form
      });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch (_err){ data = { raw: text }; }
      if (!res.ok){
        const msg = data.detail || data.error || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    };

    // Attach: read PDF/DOCX/TXT and paste into the composer
    el("btnAttach").addEventListener("click", () => {
      const picker = document.createElement("input");
      picker.type = "file";
      picker.accept = ".pdf,.docx,.txt";
      picker.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try{
          showToast("Reading file...");
          const data = await extractText(file);
          msgInput.value = data.text || "";
          resizeMsg();
          msgInput.focus();
        } catch (err){
          showToast(err?.message || "Could not read that file.");
        }
      });
      picker.click();
    });
    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
    const resizeMsg = () => {
      if (!msgInput) return;
      msgInput.style.height = "auto";
      const style = getComputedStyle(msgInput);
      const line = parseFloat(style.lineHeight) || 18;
      const padding = (parseFloat(style.paddingTop) || 0) + (parseFloat(style.paddingBottom) || 0);
      const minH = line * 2 + padding;
      const maxH = line * 10 + padding;
      const next = clamp(msgInput.scrollHeight, minH, maxH);
      msgInput.style.height = `${next}px`;
      msgInput.style.overflowY = msgInput.scrollHeight > maxH ? "auto" : "hidden";
    };
    if (btnClearDemo){
      btnClearDemo.addEventListener("click", () => {
        UIStore.clear();
        window.location.reload();
      });
    }

    const btnProfile = el("btnProfile");
    const btnStory = el("btnStory");
    const btnProfileMenu = el("btnProfileMenu");
    const btnStoryMenu = el("btnStoryMenu");
    btnProfile.addEventListener("click", () => setView("profile"));
    btnStory.addEventListener("click", () => setView("storybook"));
    if (btnProfileMenu){
      btnProfileMenu.addEventListener("click", () => setView("profile"));
    }
    if (btnStoryMenu){
      btnStoryMenu.addEventListener("click", () => setView("storybook"));
    }
    const gearWrap = document.querySelector(".pc-gear-wrap");
    const profileTrigger = document.querySelector(".pc-user");
    const brandMenus = document.querySelectorAll(".brand-menu");

    if (profileTrigger && gearWrap){
      profileTrigger.addEventListener("click", (e) => {
        e.stopPropagation();
        gearWrap.classList.toggle("open");
      });
      document.addEventListener("click", (e) => {
        if (!gearWrap.contains(e.target)){
          gearWrap.classList.remove("open");
        }
      });
    }
    if (brandMenus.length){
      brandMenus.forEach((menu) => {
        const trigger = menu.querySelector(".brand-logo");
        if (!trigger) return;
        trigger.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          menu.classList.toggle("open");
        });
      });
      document.addEventListener("click", (e) => {
        document.querySelectorAll(".brand-menu.open").forEach((menu) => {
          if (!menu.contains(e.target)) menu.classList.remove("open");
        });
      });
    }

    const clearLocalUIState = () => {
      try{
        Object.keys(localStorage)
          .filter((k) => k.startsWith("sb.ui.v1::"))
          .forEach((k) => localStorage.removeItem(k));
      } catch (_err){}
    };
    const logoutLinks = document.querySelectorAll("[data-logout='true']");
    if (logoutLinks.length){
      logoutLinks.forEach((link) => {
        link.addEventListener("click", () => {
          clearLocalUIState();
        });
      });
    }

    // New casefile modal open/close
    btnNewCasefile.addEventListener("click", () => {
      openModal({ mode: "manual" });
    });

    btnCancel.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    function openModal(opts){
      const mode = opts?.mode || "manual";
      const serverCaseId = opts?.serverCaseId || "";
      modalTitle.textContent = mode === "server" ? "Name New Casefile" : "New Casefile";
      modalHint.textContent = mode === "server"
        ? "A new casefile was created on the server. Add a title and company so it appears in your list."
        : "";
      modalBackdrop.dataset.mode = mode;
      modalBackdrop.dataset.serverCaseId = serverCaseId;
      modalBackdrop.style.display = "flex";
      inputRole.value = opts?.role || "";
      inputCompany.value = opts?.company || "";
      btnCreate.disabled = !(inputRole.value.trim() && inputCompany.value.trim());
      inputRole.focus();
    }

    function closeModal(){
      modalBackdrop.style.display = "none";
      modalBackdrop.dataset.mode = "";
      modalBackdrop.dataset.serverCaseId = "";
    }

    // Enable Create button only when role + company exist
    [inputRole, inputCompany].forEach(inp => {
      inp.addEventListener("input", () => {
        btnCreate.disabled = !(inputRole.value.trim() && inputCompany.value.trim());
      });
    });

    btnCreate.addEventListener("click", async () => {
      const role = inputRole.value.trim();
      const company = inputCompany.value.trim();
      const mode = modalBackdrop.dataset.mode || "manual";
      const serverCaseId = modalBackdrop.dataset.serverCaseId || "";
      const cf = await DataAdapter.createCasefile({ role, company, stage: "screen" });
      if (mode === "server" && serverCaseId){
        const storeSnapshot = ensureOrchStore();
        const orch = storeSnapshot.orch || { userId: null, caseMap: {} };
        orch.caseMap = orch.caseMap || {};
        orch.caseMap[cf.id] = serverCaseId;
        storeSnapshot.orch = orch;
        UIStore.save(storeSnapshot);
      }
      const refreshed = await refreshCasefiles();
      if (cf && cf.id && !refreshed.some((c) => c.id === cf.id)){
        state.casefiles = [...refreshed, cf];
      }
      closeModal();
      render();
      setActive(cf.id);
      ensureStageOpen(cf.stage);
    });

    function ensureStageOpen(stage){
      const details = document.querySelector(`details.stage[data-stage="${stage}"]`);
      if (details) details.open = true;
    }

    function setActive(caseId){
      state.activeCaseId = caseId;
      DataAdapter.setActiveCasefile(caseId);
      const cf = state.casefiles.find(c => c.id === caseId);
      if (!cf) return;

      setView("casefile");
      updateCompass(cf);
      render();
      loadMessages(caseId);

      // Update selected highlight
      document.querySelectorAll(".case-link").forEach(btn => btn.classList.remove("active"));
      const activeBtn = document.querySelector(`.case-link[data-id="${caseId}"]`);
      if (activeBtn) activeBtn.classList.add("active");
    }

    async function refreshCasefiles(){
      const result = DataAdapter.listCasefilesByStage();
      const list = (result && typeof result.then === "function") ? await result : result;
      const casefiles = Array.isArray(list) ? list : [];
      state.casefiles = casefiles;
      return casefiles;
    }

    // Render case lists by stage + counts
    function render(){
      const stages = ["screen","validate","prepare","advance","launch","closed"];
      for (const s of stages){
        const list = el(`list-${s}`);
        const count = el(`count-${s}`);
        const details = document.querySelector(`details.stage[data-stage="${s}"]`);
        list.innerHTML = "";

        const items = state.casefiles.filter(c => c.stage === s);
        count.textContent = items.length;
        if (details){
          details.classList.toggle("has-items", items.length > 0);
          details.classList.toggle("empty", items.length === 0);
          const activeIsHere = state.activeCaseId
            && state.casefiles.find(c => c.id === state.activeCaseId)?.stage === s;
          details.classList.toggle("active-folded", !!activeIsHere && !details.open);
          details.classList.toggle("active-open", !!activeIsHere && details.open);
        }

        for (const cf of items){
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "case-link";
          btn.dataset.id = cf.id;
          btn.textContent = `${cf.role}, ${cf.company}`;
          btn.addEventListener("click", () => setActive(cf.id));
          btn.draggable = true;
          btn.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", cf.id);
            e.dataTransfer.effectAllowed = "move";
          });
          list.appendChild(btn);
        }
      }

      // If nothing is active and we have casefiles, keep headers sane
      if (!state.activeCaseId){
        updateCompass(null);
        state.messages = [];
        renderMessages();
      }
    }

    function bindStageDnD(){
      document.querySelectorAll("details.stage").forEach((details) => {
        const stage = details.dataset.stage;
        const summary = details.querySelector("summary");
        const list = details.querySelector(".case-list");

        [summary, list].forEach((target) => {
          target.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
            details.classList.add("drop-target");
          });
          target.addEventListener("dragleave", () => {
            details.classList.remove("drop-target");
          });
          target.addEventListener("drop", (e) => {
            e.preventDefault();
            details.classList.remove("drop-target");
            const caseId = e.dataTransfer.getData("text/plain");
            moveCasefile(caseId, stage);
          });
        });
      });
    }

    // Optional: you can wire these to future “advance stage” actions
    // moveCasefile(caseId, "prepare") etc.
    function moveCasefile(caseId, newStage){
      const cf = state.casefiles.find(c => c.id === caseId);
      if (!cf) return;
      cf.stage = newStage;
      DataAdapter.updateCasefileStage(caseId, newStage);
      render();
      setActive(caseId);
      ensureStageOpen(newStage);
      showToast(`Moved casefile to ${stageLabel(newStage)}.`);
    }

    // Message input: Enter sends, Shift+Enter adds a newline
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        const val = e.target.value.trim();
        if (!val) return;
        e.preventDefault();
        sendMessage(val);
        msgInput.value = "";
        resizeMsg();
      }
    });
    const promptChangedTooMuch = (input, seed) => {
      const a = (seed || "").trim();
      const b = (input || "").trim();
      if (!a) return false;
      if (b.startsWith(a)) return false; // allow any additions after seed
      const m = a.length;
      const n = Math.min(b.length, m);
      const bSlice = b.slice(0, m);
      const dp = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
      for (let i = 0; i <= m; i++) dp[i][0] = i;
      for (let j = 0; j <= n; j++) dp[0][j] = j;
      for (let i = 1; i <= m; i++){
        for (let j = 1; j <= n; j++){
          const cost = a[i - 1] === bSlice[j - 1] ? 0 : 1;
          dp[i][j] = Math.min(
            dp[i - 1][j] + 1,
            dp[i][j - 1] + 1,
            dp[i - 1][j - 1] + cost
          );
        }
      }
      const distance = dp[m][n];
      return (distance / m) > 0.2;
    };

    msgInput.addEventListener("input", () => {
      resizeMsg();
      if (state.intentSeedPrompt && promptChangedTooMuch(msgInput.value, state.intentSeedPrompt)){
        state.intentKey = null;
        state.intentSeedPrompt = null;
        state.compass.selectedStepLabel = null;
        renderCompass();
      }
    });

    function setView(view){
      state.activeView = view;
      const isCasefile = view === "casefile";
      chat.style.display = "flex";
      el("compass").style.display = isCasefile ? "flex" : "none";
      composer.style.display = isCasefile ? "flex" : "none";
      markdownView.style.display = "none";
      btnProfile.classList.toggle("active", view === "profile");
      btnStory.classList.toggle("active", view === "storybook");

      if (view === "profile"){
        loadProfileView();
      } else if (view === "storybook"){
        loadStorybookView();
      }
    }

    function showReadOnly(markdown){
      chatEmpty.style.display = "none";
      messagesEl.innerHTML = "";
      const div = document.createElement("div");
      div.className = "msg assistant readonly";
      div.innerHTML = renderMarkdown(markdown || "");
      messagesEl.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function loadProfileView(){
      showReadOnly("Loading profile...");
      try{
        const resp = await DataAdapter.getU01();
        const md = buildProfileMarkdown(resp?.u01);
        showReadOnly(md);
      } catch (err){
        showReadOnly(`Unable to load profile.\n\n${err?.message || "Please try again."}`);
      }
    }

    async function loadStorybookView(){
      showReadOnly("Loading storybook...");
      try{
        const resp = await DataAdapter.getU02();
        const md = buildStoryMarkdown(resp?.stories || []);
        showReadOnly(md);
      } catch (err){
        showReadOnly(`Unable to load storybook.\n\n${err?.message || "Please try again."}`);
      }
    }

    function stageLabel(stage){
      const map = {
        screen: "Screen",
        validate: "Pursue",
        prepare: "Interview",
        advance: "Offer",
        launch: "Transition",
        closed: "Close"
      };
      return map[stage] || "Screen";
    }

    function formatSystemState(value){
      if (!value) return "—";
      return String(value).toUpperCase();
    }

    function updateCompass(cf){
      const stageKey = cf?.stage || "screen";
      const config = COMPASS_CONFIG[stageKey] || COMPASS_CONFIG.screen;
      const stage = stageLabel(stageKey);

      state.activeStage = stage;
      state.intentKey = null;

      if (!cf){
        if (compassActive) compassActive.textContent = "No active casefile selected";
      } else {
        if (compassActive) compassActive.textContent = `Active Casefile: ${cf.role}, ${cf.company}`;
      }
      const store = UIStore.load();
      const stateMap = store.orch?.stateMap || {};
      state.systemState = cf?.id ? (stateMap[cf.id] || null) : null;
      if (compassStageMeta) compassStageMeta.textContent = `System State: ${formatSystemState(state.systemState)}`;

      state.compass = {
        stage,
        where: config.goal,
        suggestedPrompt: "",
        steps: config.steps || [],
        selectedStepLabel: null
      };
      renderCompass();
    }

    function renderCompass(){
      if (compassWhere){
        compassWhere.textContent = `${state.compass.stage} ? ${state.compass.where}`;
      }
      compassSteps.innerHTML = "";
      for (const step of state.compass.steps){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "compass-pill";
        btn.textContent = step.label;
        if (state.compass.selectedStepLabel === step.label){
          btn.classList.add("active");
        }
        btn.addEventListener("click", () => {
          state.compass.selectedStepLabel = step.label;
          state.intentKey = step.intent_key || null;
          state.intentSeedPrompt = step.seed_prompt || "";
          msgInput.value = step.seed_prompt || "";
          resizeMsg();
          msgInput.focus();
          renderCompass();
        });
        compassSteps.appendChild(btn);
      }
    }

    function loadMessages(caseId){
      const result = DataAdapter.getMessages(caseId);
      if (result && typeof result.then === "function"){
        result.then((msgs) => {
          state.messages = Array.isArray(msgs) ? msgs : [];
          state.scrollMode = "bottom";
          renderMessages();
        }).catch(() => {
          state.messages = [];
          state.scrollMode = "bottom";
          renderMessages();
        });
      } else {
        state.messages = Array.isArray(result) ? result : [];
        state.scrollMode = "bottom";
        renderMessages();
      }
    }

    function renderMessages(){
      messagesEl.innerHTML = "";
      if (!state.messages.length){
        chatEmpty.style.display = "none";
        const div = document.createElement("div");
        div.className = "msg assistant";
        div.innerHTML = renderMarkdown(emptyGuidance(state.activeStage));
        messagesEl.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        return;
      }
      chatEmpty.style.display = "none";
      for (const msg of state.messages){
        const div = document.createElement("div");
        div.className = `msg ${msg.role}`;
        if (msg.role === "assistant"){
          div.innerHTML = renderMarkdown(msg.content || "");
        } else {
          div.textContent = msg.content || "";
        }
        messagesEl.appendChild(div);
      }
      if (state.scrollMode === "assistant-top"){
        const assistants = messagesEl.querySelectorAll(".msg.assistant");
        const lastAssistant = assistants[assistants.length - 1];
        if (lastAssistant){
          const chatRect = chat.getBoundingClientRect();
          const msgRect = lastAssistant.getBoundingClientRect();
          const targetTop = (msgRect.top - chatRect.top) + chat.scrollTop - 20;
          chat.scrollTop = Math.max(0, targetTop);
        }
        state.scrollMode = null;
        return;
      }
      if (state.scrollMode === "bottom"){
        chat.scrollTop = chat.scrollHeight;
        state.scrollMode = null;
      }
    }

    function renderMarkdown(input){
      if (!input) return "";
      const escaped = escapeHtml(String(input).replace(/\r\n/g, "\n"));
      const withBlocks = renderBlockMarkdown(escaped);
      return renderInlineMarkdown(withBlocks);
    }

    function escapeHtml(text){
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderInlineMarkdown(text){
      return text
        .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
        .replace(/`([^`]+)`/g, "<code>$1</code>");
    }

    function renderBlockMarkdown(text){
      const lines = text.split("\n");
      let html = "";
      let listType = null; // "ul" | "ol"
      let listItemOpen = false;
      let inCode = false;
      let paragraph = [];

      const flushParagraph = () => {
        if (paragraph.length){
          html += `<p>${paragraph.join(" ")}</p>`;
          paragraph = [];
        }
      };
      const closeList = () => {
        if (listItemOpen){
          html += "</li>";
          listItemOpen = false;
        }
        if (listType){
          html += `</${listType}>`;
          listType = null;
        }
      };
      const openList = (type) => {
        if (listType !== type){
          closeList();
          html += `<${type}>`;
          listType = type;
        }
      };

      for (const rawLine of lines){
        const line = rawLine.trimEnd();
        if (line.startsWith("```")){
          flushParagraph();
          closeList();
          if (!inCode){
            html += "<pre><code>";
            inCode = true;
          } else {
            html += "</code></pre>";
            inCode = false;
          }
          continue;
        }
        if (inCode){
          html += `${line}\n`;
          continue;
        }

        if (!line.trim()){
          flushParagraph();
          if (listItemOpen){
            html += "<br>";
          }
          continue;
        }

        if (/^---+$/.test(line.trim())){
          flushParagraph();
          closeList();
          html += "<hr />";
          continue;
        }

        if (line.startsWith("### ")){
          flushParagraph();
          closeList();
          html += `<h3>${line.slice(4)}</h3>`;
          continue;
        }
        if (line.startsWith("## ")){
          flushParagraph();
          closeList();
          html += `<h2>${line.slice(3)}</h2>`;
          continue;
        }
        if (line.startsWith("# ")){
          flushParagraph();
          closeList();
          html += `<h1>${line.slice(2)}</h1>`;
          continue;
        }

        const ulMatch = line.match(/^[-*]\s+(.*)/);
        if (ulMatch){
          flushParagraph();
          if (listType === "ol" && listItemOpen){
            html += `<div>&bull; ${ulMatch[1]}</div>`;
          } else {
            openList("ul");
            if (listItemOpen) html += "</li>";
            html += `<li>${ulMatch[1]}`;
            listItemOpen = true;
          }
          continue;
        }

        const olMatch = line.match(/^\d+\.\s+(.*)/);
        if (olMatch){
          flushParagraph();
          openList("ol");
          if (listItemOpen) html += "</li>";
          html += `<li>${olMatch[1]}`;
          listItemOpen = true;
          continue;
        }

        if (listType && listItemOpen){
          html += `<div>${line}</div>`;
        } else {
          paragraph.push(line);
        }
      }

      flushParagraph();
      closeList();
      if (inCode) html += "</code></pre>";
      return html;
    }

    function emptyGuidance(stage){
      return `**Welcome to SignalBench — the Interview Operating System.**

Here is a quick, practical tour so you can orient fast:

**1) Navigation & Profile**
Click the four-ties logo to open the main menu. Your profile and subscription tier are in the lower left; clicking your profile image also opens the menu.

**2) Casefiles & Stages**
Each casefile represents one opportunity. If you did not add one yet, click **+ New Casefile**, add a title and company, and import the job description. New casefiles begin in **Screen**. Drag and drop to move stages, and click a stage title to expand or collapse it.

**3) Action Bar & Prompts**
The action bar shows your Active Casefile and three optional Auto-Prompts. You can edit a prompt or just type your own message. Press Enter to send.

**4) Attachments & System State**
Use the **+** icon to attach job descriptions, company intelligence, or resume edits. The System State indicator reflects internal context and does not require action.

**5) Dialogue Panel**
The right panel is your working dialogue for analysis, signal interpretation, and decision framing.

**To get started:** choose an auto-prompt below, or type your own message. If you feel stuck, just type “What’s next?” or “I’m stuck.”

At all times, you control the pace, progress, and direction. The system provides structure and judgment support as you move forward.`;
    }

    function stageToState(stage){
      const map = {
        Screen: "BUILDCASE",
        Pursue: "JUDGEROLE",
        Interview: "SIGNALTUNE",
        Offer: "CAPTUREDEBRIEF",
        Transition: "NEGOTIATE",
        Close: "JUMPSTART"
      };
      return map[stage] || "BUILDCASE";
    }

    function ensureOrchStore(){
      const store = UIStore.load();
      if (!store.me){
        const id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
        store.me = { id, email: null };
      }
      if (!store.orch) store.orch = { userId: null, caseMap: {} };
      if (!store.orch.caseMap) store.orch.caseMap = {};
      if (!store.orch.stateMap) store.orch.stateMap = {};
      UIStore.save(store);
      return store;
    }

    function hydrateProfileCard(){
      const store = UIStore.load();
      const nameEl = document.getElementById("profileName");
      const avatarEl = document.getElementById("profileAvatar");
      const displayName = store.me?.preferred_name || store.me?.full_name || store.me?.email || "New User";
      if (nameEl) nameEl.textContent = displayName;
      if (avatarEl && store.me?.avatar_data_url){
        avatarEl.src = store.me.avatar_data_url;
      }
    }

    async function sendMessage(text){
      if (!state.activeCaseId){
        const assistantMsg = {
          id: String(Date.now()) + Math.random().toString(16).slice(2),
          role: "assistant",
          content: "Please create or select a casefile before continuing. Error 1042.",
          createdAt: new Date().toISOString()
        };
        state.messages.push(assistantMsg);
        DataAdapter.sendMessage(state.activeCaseId || "no-case", assistantMsg);
        renderMessages();
        return;
      }
      const storeSnapshot = ensureOrchStore();
      const userMsg = DataAdapter.sendMessage(state.activeCaseId, {
        id: String(Date.now()) + Math.random().toString(16).slice(2),
        role: "user",
        content: text,
        createdAt: new Date().toISOString(),
        intent_key: state.intentKey || null,
        stage: state.activeStage,
        casefile_id: state.activeCaseId,
        has_u01: !!storeSnapshot.u01,
        has_u02: !!storeSnapshot.u02
      });
      state.intentKey = null;
      state.intentSeedPrompt = null;
      state.compass.selectedStepLabel = null;
      renderCompass();
      state.messages.push(userMsg);
      const needsCaseReminder = !state.casefiles || state.casefiles.length === 0;
      if (needsCaseReminder){
        state.noCaseReminderCount += 1;
      }
      state.scrollMode = "bottom";
      renderMessages();
      typingEl.style.display = "block";

      const assistantMsg = {
        id: String(Date.now()) + Math.random().toString(16).slice(2),
        role: "assistant",
        content: "Thinking...",
        createdAt: new Date().toISOString()
      };
      state.messages.push(assistantMsg);
      state.scrollMode = "bottom";
      renderMessages();

      const orch = storeSnapshot.orch || { userId: null, caseMap: {} };
      const payload = {
        user_message: text,
        user_email: storeSnapshot.me?.email || null,
        user_id: orch.userId || storeSnapshot.me?.id || null,
        case_id: orch.caseMap[state.activeCaseId] || state.activeCaseId || null,
        selected_action_id: state.compass.selectedStepLabel || null,
        user_intent: state.intentKey || null,
        client_state_hint: stageToState(state.activeStage)
      };

      try{
        const resp = await DataAdapter.sendTurn(payload);
        if (resp && resp.user_id){
          orch.userId = resp.user_id;
        }
        if (resp && resp.case_id){
          const serverCaseId = resp.case_id;
          orch.caseMap = orch.caseMap || {};
          const activeLocalId = state.activeCaseId;
          const activeServerId = activeLocalId ? orch.caseMap[activeLocalId] : null;
          const existingLocalId = Object.keys(orch.caseMap).find((key) => orch.caseMap[key] === serverCaseId);
          if (existingLocalId){
            if (existingLocalId !== activeLocalId){
              setActive(existingLocalId);
            }
          } else if (!activeServerId && activeLocalId){
            orch.caseMap[activeLocalId] = serverCaseId;
          } else if (activeServerId && activeServerId !== serverCaseId){
            openModal({ mode: "server", serverCaseId });
            showToast("Name the new casefile so it appears in your list.");
          }
        }
        if (resp && resp.state_executed){
          orch.stateMap = orch.stateMap || {};
          if (state.activeCaseId){
            orch.stateMap[state.activeCaseId] = resp.state_executed;
          }
          state.systemState = resp.state_executed;
          if (compassStageMeta){
            compassStageMeta.textContent = `System State: ${formatSystemState(state.systemState)}`;
          }
        }
        storeSnapshot.orch = orch;
        UIStore.save(storeSnapshot);
        assistantMsg.content = resp.assistant_message || "(empty response)";
      } catch (err){
        assistantMsg.content = "The system took too long to respond. Please try your prompt again. Error 1500.";
        showToast(err?.message || "Request failed.");
      } finally {
        typingEl.style.display = "none";
        DataAdapter.sendMessage(state.activeCaseId, assistantMsg);
        state.scrollMode = "assistant-top";
        renderMessages();
        if (needsCaseReminder && state.noCaseReminderCount % 4 === 0){
          const reminder = {
            id: String(Date.now()) + Math.random().toString(16).slice(2),
            role: "assistant",
            content: "The real power of InterviewOS is when we compare what you're looking for in your next role to a target job description.  Click the New Casefile button, enter a Title and Company, then when you come back to this chat, upload a Job Description.",
            createdAt: new Date().toISOString()
          };
          state.messages.push(reminder);
          DataAdapter.sendMessage(state.activeCaseId, reminder);
          renderMessages();
        }
      }
    }

    function enforceDemoGuards(){
      const demoAuth = { isAuthed: true, isOnboarded: true };
      const route = window.location.hash || "#/app";
      let allowed = true;
      if (route !== "#/auth" && !demoAuth.isAuthed) allowed = false;
      if (route === "#/app" && demoAuth.isAuthed && !demoAuth.isOnboarded) allowed = false;

      if (!allowed){
        guardBanner.style.display = "block";
        appShell.classList.add("guarded");
        window.location.hash = demoAuth.isAuthed ? "#/onboarding" : "#/auth";
      }
    }

    function showToast(message){
      if (!toast) return;
      toast.textContent = message;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => {
        toast.style.display = "none";
      }, 1600);
    }

    const syncIdentity = async () => {
      try{
        const res = await fetch(`${API_BASE}/whoami`, { credentials: "include" });
        if (!res.ok) return;
        const data = await res.json();
        if (!data || !data.email) return;
        UIStore.activateUser?.(data.email);
        const store = UIStore.load();
        store.me = store.me || { id: data.user_id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())), email: data.email };
        store.me.email = data.email;
        if (data.user_id){
          store.me.id = data.user_id;
        }
        store.orch = store.orch || { userId: data.user_id || store.me.id, caseMap: {} };
        if (data.user_id){
          store.orch.userId = data.user_id;
        }
        UIStore.save(store, data.email);
      } catch (_err){
        // noop
      }
    };

    const refreshProfileFromU01 = async () => {
      try{
        const resp = await DataAdapter.getU01();
        const record = resp?.u01;
        if (!record) return;
        const content = record.content_json || record.contentJson || record;
        if (!content) return;
        const store = UIStore.load();
        store.me = store.me || { id: resp.user_id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())), email: store.me?.email || "" };
        if (content.full_name) store.me.full_name = content.full_name;
        if (content.preferred_name) store.me.preferred_name = content.preferred_name;
        if (content.email) store.me.email = content.email;
        if (content.avatar_data_url) store.me.avatar_data_url = content.avatar_data_url;
        UIStore.save(store);
      } catch (_err){
        // noop
      }
    };

    const boot = async () => {
      await syncIdentity();
      await refreshProfileFromU01();
      ensureOrchStore();
      hydrateProfileCard();
      resizeMsg();

      // Initial render
      await refreshCasefiles();
      render();
      const lastActive = DataAdapter.getActiveCasefile();
      const activeExists = lastActive && state.casefiles.some(c => c.id === lastActive);
      if (activeExists){
        setActive(lastActive);
      } else if (state.casefiles.length){
        const lastCase = state.casefiles[state.casefiles.length - 1];
        if (lastCase && lastCase.id){
          setActive(lastCase.id);
        } else {
          updateCompass(null);
        }
      } else {
        updateCompass(null);
      }
      bindStageDnD();
      enforceDemoGuards();
    };

    boot();

    // DEV HOOK (comment out anytime): seed an example
    // state.casefiles.push({id:"seed1", role:"VP Opex", company:"MacQueen", stage:"prepare"});
    // render(); setActive("seed1"); ensureStageOpen("prepare");
  </script>
</body>
</html>
