<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SignalBench beta | Settings</title>
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon/favicon-16x16.png" />
  <link rel="apple-touch-icon" href="icons/favicon/apple-touch-icon.png" />
  <link rel="manifest" href="icons/favicon/site.webmanifest" />
  <link rel="stylesheet" href="ui_shell.css" />
  <script src="ui_theme.js"></script>
  <script src="ui_store.js"></script>
  <script src="ui_guard.js"></script>
</head>
<body data-page="settings">
  <!--
    Integration Notes (Settings)
    - Save preferences: tone, length, career level, employment status
    - Route back to /app
  -->
  <div class="wrap">
    <div class="page">
                  <header class="page-header">
        <div class="brand large">
          <div class="brand-menu">
            <button class="brand-logo" type="button" aria-label="Open navigation">
              <img src="icons/logo1_round_80.png" alt="SignalBench logo" />
            </button>
            <div class="brand-panel" role="menu">
              <a href="app.html" role="menuitem">App</a>
              <a href="settings.html" role="menuitem">Settings</a>
              <a href="feedback.html" role="menuitem">Feedback</a>
            </div>
          </div>
          <span class="brand-name">SignalBench</span>
        </div>
      </header>

      <main class="page-body">
        <section class="card">
          <h1 class="title">Response Preferences</h1>
          <div class="row">
            <label class="field" style="flex:1">
              <span>Tone</span>
              <input id="toneSlider" type="range" min="0" max="10" value="5" style="width:100%;" />
              <div class="note">Softened and eloquent ←→ Blunt and direct</div>
              <div class="note"><small>The system remains direct and truthful either way.</small></div>
            </label>
            <label class="field" style="flex:1">
              <span>Length</span>
              <input id="lengthSlider" type="range" min="0" max="10" value="5" style="width:100%;" />
              <div class="note">Brief ←→ Detailed</div>
              <div class="note"><small>Choose how concise you want responses to be.</small></div>
            </label>
          </div>
        </section>

        <section class="card">
          <h2 class="title" style="font-size:22px;">Career context</h2>
          <p class="subtitle">These settings help SignalBench tailor guidance to your level and situation.</p>

          <div class="field" style="margin-top:10px;">
            <span>Career level sought for next role</span>
            <div class="note">Select up to two.</div>
            <div class="row" style="flex-direction:column; margin-top:6px;">
              <label class="pill"><input type="checkbox" name="level" value="ic" /> Individual contributor</label>
              <label class="pill"><input type="checkbox" name="level" value="mgr" /> Manager (people manager)</label>
              <label class="pill"><input type="checkbox" name="level" value="dir" /> Director (manages managers)</label>
              <label class="pill"><input type="checkbox" name="level" value="vp" /> VP / General Manager</label>
              <label class="pill"><input type="checkbox" name="level" value="cxo" /> C‑suite / President</label>
              <label class="pill"><input type="checkbox" name="level" value="na" /> Not sure</label>
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <span>Current employment status</span>
            <div class="note">Select one.</div>
            <div class="row" style="flex-direction:column; margin-top:6px;">
              <label class="pill"><input type="radio" name="status" value="ft_adv" /> Employed, exploring internal or external opportunities</label>
              <label class="pill"><input type="radio" name="status" value="pt_contract" /> Contract or part‑time, seeking full‑time</label>
              <label class="pill"><input type="radio" name="status" value="transition_ft" /> In transition, seeking full‑time only</label>
              <label class="pill"><input type="radio" name="status" value="transition_any" /> In transition, open to full‑time, part‑time, or contract</label>
              <label class="pill"><input type="radio" name="status" value="na" /> Prefer not to say</label>
            </div>
          </div>
        </section>

        <section class="card">
          <h2 class="title" style="font-size:22px;">Theme</h2>
          <div class="row">
            <label class="pill"><input type="radio" name="theme" value="editorial" checked /> Editorial Slate</label>
            <label class="pill"><input type="radio" name="theme" value="graphite" /> Graphite + Signal</label>
            <label class="pill"><input type="radio" name="theme" value="linen" /> Warm Linen</label>
            <label class="pill"><input type="radio" name="theme" value="batman" /> Batman (Night)</label>
          </div>
        </section>

        <section class="card">
          <div class="row">
            <button class="btn primary press-invert" id="btnSaveSettings" type="button">Save Settings</button>
            <a class="btn press-invert" href="app.html">Return to App without Saving</a>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    const btnSave = document.getElementById("btnSaveSettings");
    const toneSlider = document.getElementById("toneSlider");
    const lengthSlider = document.getElementById("lengthSlider");
    const themeRadios = Array.from(document.querySelectorAll("input[name='theme']"));
    const levelChecks = Array.from(document.querySelectorAll("input[name='level']"));
    const statusRadios = Array.from(document.querySelectorAll("input[name='status']"));

    const API_BASE = "https://api.signal-bench.com";
    const getJson = async (path) => {
      const res = await fetch(`${API_BASE}${path}`, { credentials: "include" });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch (_err){ data = { raw: text }; }
      if (!res.ok){
        const msg = data.detail || data.error || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    };
    const postJson = async (path, payload) => {
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload || {})
      });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch (_err){ data = { raw: text }; }
      if (!res.ok){
        const msg = data.detail || data.error || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    };

    // Hydrate from SQL
    const storeInit = UIStore.load();
    const resolveUser = () => ({
      userId: storeInit.orch?.userId || storeInit.me?.id || null,
      userEmail: storeInit.me?.email || ""
    });
    const hydratePrefs = async () => {
      const { userId, userEmail } = resolveUser();
      if (!userId && !userEmail) return;
      const qs = userId ? `?user_id=${encodeURIComponent(userId)}` : `?user_email=${encodeURIComponent(userEmail)}`;
      try{
        const resp = await getJson(`/preferences${qs}`);
        const prefs = resp.preferences || {};
        if (prefs.tone !== null && prefs.tone !== undefined) toneSlider.value = prefs.tone;
        if (prefs.length !== null && prefs.length !== undefined) lengthSlider.value = prefs.length;
        if (Array.isArray(prefs.career_level)){
          levelChecks.forEach((c) => c.checked = prefs.career_level.includes(c.value));
        } else if (typeof prefs.career_level === "string"){
          const parts = prefs.career_level.split(",").map((x) => x.trim()).filter(Boolean);
          levelChecks.forEach((c) => c.checked = parts.includes(c.value));
        }
        if (prefs.employment_status){
          const r = statusRadios.find((x) => x.value === prefs.employment_status);
          if (r) r.checked = true;
        }
      } catch (_err){
        // ignore load errors for now
      }
    };
    hydratePrefs();
    const themeKey = localStorage.getItem("sb.ui.theme") || "editorial";
    themeRadios.forEach((r) => r.checked = r.value === themeKey);
    btnSave.addEventListener("click", async () => {
      const store = UIStore.load();
      const payload = {
        user_id: store.orch?.userId || store.me?.id || null,
        user_email: store.me?.email || "",
        tone: Number(toneSlider.value),
        length: Number(lengthSlider.value),
        career_level: levelChecks.filter((c) => c.checked).map((c) => c.value),
        employment_status: statusRadios.find((r) => r.checked)?.value || ""
      };
      const theme = themeRadios.find((r) => r.checked)?.value || "editorial";
      localStorage.setItem("sb.ui.theme", theme);
      UITheme.applyTheme(theme);
      try{
        await postJson("/preferences", payload);
        window.location.href = "app.html";
      } catch (err){
        alert(err?.message || "Could not save settings.");
      }
    });
    themeRadios.forEach((r) => r.addEventListener("change", () => {
      localStorage.setItem("sb.ui.theme", r.value);
      UITheme.applyTheme(r.value);
    }));
  </script>


  <script>
    document.querySelectorAll(".brand-menu").forEach((menu) => {
      const trigger = menu.querySelector(".brand-logo");
      if (!trigger) return;
      trigger.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        menu.classList.toggle("open");
      });
    });
    document.addEventListener("click", (e) => {
      document.querySelectorAll(".brand-menu.open").forEach((menu) => {
        if (!menu.contains(e.target)) menu.classList.remove("open");
      });
    });
  </script>

  <style>
    .press-invert:active{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .press-invert.primary:active{
      background:#fff;
      color:var(--accent);
      border-color:var(--accent);
    }
    .press-invert.danger:active{
      background:#fff;
      color:#b3261e;
      border-color:#b3261e;
    }
  </style>
</body>
</html>
